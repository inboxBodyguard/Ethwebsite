<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login | EZM Cyber - Your Digital Security Partner</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      color: #e0e6ed; font-family: 'Inter', sans-serif; line-height: 1.6; min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }
    .login-container { width:100%; max-width:400px; margin:2rem; background: rgba(22,33,62,0.8);
      backdrop-filter: blur(15px); border-radius:16px; padding:2.5rem; border:1px solid rgba(0,255,204,0.2);
      box-shadow:0 20px 40px rgba(0,0,0,0.4); position:relative; overflow:hidden;
    }
    .login-container::before{ content:''; position:absolute; top:0; left:0; right:0; height:2px;
      background:linear-gradient(90deg, transparent, #00ffcc, transparent);
    }
    .brand-logo{text-align:center; margin-bottom:2rem;}
    .brand-logo h1{ font-size:2rem; font-weight:700; color:#00ffcc; margin-bottom:.5rem; text-shadow:0 0 10px rgba(0,255,204,.3); }
    .brand-logo p{ color:#b8c6db; font-size:.9rem; margin:0; }

    .form-group{ margin-bottom:1.5rem; }
    .form-label{ display:block; color:#e0e6ed; font-weight:500; margin-bottom:.5rem; font-size:.9rem; }
    .form-control{ width:100%; padding:12px 16px; background: rgba(16,21,30,0.8); border:1px solid rgba(0,255,204,0.3);
      border-radius:8px; color:#fff; font-size:1rem; transition:all .3s ease;
    }
    .form-control:focus{ outline:none; border-color:#00ffcc; background: rgba(16,21,30,0.9); box-shadow:0 0 0 3px rgba(0,255,204,0.1); }
    .form-control::placeholder{ color:#8a94a6; }

    .btn-primary{ width:100%; padding:14px; background:linear-gradient(135deg,#00ffcc,#00ccaa); color:#000; border:none;
      border-radius:8px; font-weight:600; font-size:1rem; cursor:pointer; transition:all .3s ease; margin-bottom:1rem;
    }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,255,204,0.3); }
    .google-btn{ width:100%; padding:12px 16px; background:#fff; color:#333; border:1px solid #dadce0; border-radius:8px;
      font-size:1rem; font-weight:500; cursor:pointer; display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:1.5rem;
    }
    .divider{ display:flex; align-items:center; margin:1.5rem 0; color:#8a94a6; font-size:.9rem; }
    .divider::before, .divider::after{ content:''; flex:1; height:1px; background:rgba(138,148,166,0.3); }
    .divider span{ padding:0 1rem; }

    .back-home{ position:absolute; top:1rem; left:1rem; z-index:10; }
    .back-home a{ color:#00ffcc; text-decoration:none; font-size:.9rem; display:flex; gap:.5rem; }
    .forgot-password, .signup-link { text-align:center; color:#b8c6db; font-size:.9rem; margin-top: .5rem; }
    .signup-link a, .forgot-password a { color:#00ffcc; text-decoration:none; }
    .error-message, .success-message{ padding:12px; border-radius:8px; font-size:.9rem; margin-bottom:1rem; display:none; }
    .error-message{ background:rgba(255,59,48,0.1); border:1px solid rgba(255,59,48,0.3); color:#ff6b6b; }
    .success-message{ background:rgba(52,199,89,0.1); border:1px solid rgba(52,199,89,0.3); color:#34c759; }

    .loading{ display:inline-block; width:20px; height:20px; border:2px solid rgba(0,0,0,.3); border-radius:50%; border-top-color:#000; animation:spin 1s linear infinite; }
    @keyframes spin{ to { transform:rotate(360deg); } }

    /* verification modal */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:2000; padding:1rem; }
    .verification-box { width:100%; max-width:520px; background:#0f1724; padding:1.5rem; border-radius:12px; border:1px solid rgba(0,255,204,0.12); color:#e6f7f1; box-shadow:0 20px 50px rgba(0,0,0,0.6); text-align:center; }
    .verification-box h2{ margin-bottom:.25rem; color:#00ffcc; }
    .verification-box p{ color:#b8c6db; margin-bottom:1rem; }
    .verification-actions { display:flex; gap:.75rem; justify-content:center; margin-top:1rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px 14px; border-radius:8px; color:#fff; cursor:pointer; }
    .hidden{ display:none !important; }

    @media (max-width:480px){ .login-container{ margin:1rem; padding:2rem; } .brand-logo h1{ font-size:1.75rem; } }
  </style>
</head>
<body>
  <div class="back-home">
    <a href="index.html">← Back to Home</a>
  </div>

  <div class="login-container">
    <div class="brand-logo">
      <h1>EZM Cyber</h1>
      <p>Secure Login</p>
    </div>

    <div id="error-message" class="error-message" role="alert"></div>
    <div id="success-message" class="success-message" role="status"></div>

    <!-- Google Sign-In (custom button) -->
    <button id="google-signin-btn" class="google-btn" type="button" aria-label="Sign in with Google">
      <svg width="18" height="18" viewBox="0 0 533.5 544.3" style="display:block"><path fill="#4285f4" d="M533.5 278.4c0-17.5-1.5-34.5-4.4-50.9H272.1v97.1h147.2c-6.3 34.1-25.1 62.9-53.9 82.2v68.1h87.1c51-46.9 81-116.1 81-196.5z"/></svg>
      <span id="google-btn-text">Continue with Google</span>
    </button>

    <div class="divider"><span>or</span></div>

    <!-- Traditional login -->
    <form id="login-form" autocomplete="off" novalidate>
      <div class="form-group">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" id="email" name="email" class="form-control" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="password" class="form-label">Password</label>
        <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password" required>
      </div>
      <button type="submit" class="btn-primary" id="login-btn">
        <span id="login-btn-text">Sign In</span>
      </button>
    </form>

    <div class="forgot-password">
      <a href="#" onclick="showForgotPassword(); return false;">Forgot your password?</a>
    </div>

    <div class="signup-link">
      Don't have an account? <a href="signup.html">Sign up here</a>
    </div>
  </div>

  <!-- Verification modal (hidden until needed) -->
  <div id="verification-step" class="overlay hidden" aria-hidden="true">
    <div class="verification-box" role="dialog" aria-modal="true" aria-labelledby="verify-title">
      <h2 id="verify-title">One More Step Before You Continue</h2>
      <p>Please verify that you are human to proceed.</p>

      <div id="recaptcha" style="display:flex; justify-content:center; margin: 0 auto;"></div>

      <div class="verification-actions">
        <button id="verify-continue" class="btn-primary">Verify & Continue</button>
        <button id="verify-cancel" class="btn-ghost">Cancel</button>
      </div>

      <p style="margin-top:12px; color:#9fbdb2; font-size:.85rem;">(Server-side verification required for full protection.)</p>
    </div>
  </div>

  <!-- External scripts -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    /***** CONFIG - update only keys here if needed *****/
    const GOOGLE_CLIENT_ID = '328276925081-72l44j7i0tln1ldk1kkmtelh1smjal4v.apps.googleusercontent.com';
    const RECAPTCHA_SITE_KEY = '6Lf8YtMrAAAAAB5bqKoDDQwtLcq3pLKlL_JniYaG'; // your site key
    /****************************************************/

    let savedCredentials = null;
    let recaptchaWidgetId = null;
    let recaptchaReady = false;

    // Utility messages (re-usable)
    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }
    function showSuccess(message) {
      const el = document.getElementById('success-message');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }

    // Google Sign-In: initialize once
    window.addEventListener('DOMContentLoaded', () => {
      // Initialize the Google Identity Services client
      if (window.google && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse,
          auto_select: false
        });
      }

      // Custom Google button handler
      document.getElementById('google-signin-btn').addEventListener('click', () => {
        if (window.google && google.accounts && google.accounts.id) {
          google.accounts.id.prompt(); // prompt the picker / popup
          // If user refuses or not displayed, the callback will not run — we handle gracefully
        } else {
          showError('Google Sign-In not available.');
        }
      });

      // Bind login form
      document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!email || !password) { showError('Please fill in all fields'); return; }

        // Save credentials temporarily (so we can send them after captcha)
        savedCredentials = { email, password };
        openVerificationModal();
      });

      // Verification modal buttons
      document.getElementById('verify-continue').addEventListener('click', onVerifyContinue);
      document.getElementById('verify-cancel').addEventListener('click', closeVerificationModal);

      // If user already logged in in session, redirect
      const user = sessionStorage.getItem('user');
      if (user) window.location.href = 'home.html';
    });

    // Handler when Google Identity returns a credential
    function handleCredentialResponse(response) {
      try {
        const userInfo = parseJwt(response.credential);
        sessionStorage.setItem('user', JSON.stringify({
          name: userInfo.name,
          email: userInfo.email,
          picture: userInfo.picture,
          loginMethod: 'google'
        }));
        showSuccess('Successfully signed in with Google!');
        setTimeout(() => { window.location.href = 'home.html'; }, 900);
      } catch (err) {
        console.error(err);
        showError('Google sign-in failed.');
      }
    }

    // Simple JWT decode
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    // Recaptcha onload callback (from script param)
    function onRecaptchaLoad() {
      recaptchaReady = true;
      // If modal already open, render immediately
      if (document.getElementById('verification-step').classList.contains('hidden') === false) {
        renderRecaptcha();
      }
    }

    function openVerificationModal() {
      const modal = document.getElementById('verification-step');
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');

      // render only once
      if (recaptchaWidgetId === null && recaptchaReady) renderRecaptcha();
      // If script not ready yet, onRecaptchaLoad will render when ready
    }

    function closeVerificationModal() {
      const modal = document.getElementById('verification-step');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
    }

    function renderRecaptcha() {
      try {
        if (typeof grecaptcha !== 'undefined') {
          if (recaptchaWidgetId === null) {
            recaptchaWidgetId = grecaptcha.render('recaptcha', {
              'sitekey': RECAPTCHA_SITE_KEY,
              'theme': 'light'
            });
          } else {
            // already rendered
          }
        } else {
          console.warn('grecaptcha not defined yet');
        }
      } catch (err) {
        console.error('renderRecaptcha error', err);
      }
    }

    async function onVerifyContinue(e) {
      // get token
      if (typeof grecaptcha === 'undefined') {
        showError('reCAPTCHA not loaded. If you are testing on github.io, add that domain to your reCAPTCHA allowed domains.');
        return;
      }

      const token = grecaptcha.getResponse(recaptchaWidgetId);
      if (!token) { showError('Please complete the reCAPTCHA'); return; }

      // attempt server-side verification if endpoint exists
      try {
        // If you have a server endpoint at /verify that expects form data:
        const body = new URLSearchParams();
        body.append('g-recaptcha-response', token);
        if (savedCredentials) {
          body.append('email', savedCredentials.email);
          body.append('password', savedCredentials.password);
        }

        const resp = await fetch('/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });

        if (resp.ok) {
          // assume server returned success and created session / account
          showSuccess('Verification passed. Redirecting...');
          setTimeout(() => { window.location.href = 'home.html'; }, 900);
        } else {
          // server exists but returned failure
          const text = await resp.text();
          showError('Verification failed: ' + (text || resp.statusText));
        }
      } catch (err) {
        // No server endpoint available (e.g., GitHub Pages). Fallback for testing:
        console.warn('No server /verify or network error:', err);
        showSuccess('reCAPTCHA completed locally (no server). Proceeding for testing...');
        setTimeout(() => { window.location.href = 'home.html'; }, 900);
      }
    }

    // Forgot password prompt
    function showForgotPassword() {
      const email = prompt('Enter your email address to reset your password:');
      if (email && email.includes('@')) showSuccess('Password reset instructions sent to your email!');
      else if (email) showError('Please enter a valid email address');
    }
  </script>
</body>
</html>