<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Suspicious Link Checker | EZM Cyber</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet" />
  <style>
    body {
      background-color: #0a0a0a;
      color: #e0ffe0;
      font-family: 'Orbitron', sans-serif;
      padding: 30px;
    }
    h1 { color: #00ffcc; }
    input[type="url"] {
      width: 100%;
      padding: 12px;
      background-color: #111;
      border: 1px solid #00ffcc;
      color: #fff;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      background-color: #00ffcc;
      border: none;
      color: #000;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background-color: #00ccaa; }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    #result { margin-top: 20px; font-weight: bold; }
    .loading { color: #00ffcc; }
    .scan-details {
      margin-top: 10px;
      padding: 10px;
      background-color: #111;
      border-left: 3px solid #00ffcc;
    }
    .detection-ratio {
      font-size: 1.2em;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #00ffcc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #111;
    }
  </style>
</head>
<body>

  <h1>Suspicious Link Checker</h1>
  <p>Enter a link below to verify its safety:</p>

  <form id="linkForm">
    <input type="url" id="urlInput" placeholder="Paste suspicious URL here..." required />
    <button type="submit" id="checkBtn">Check</button>
  </form>

  <div id="result"></div>

  <h2>Scan History</h2>
  <table id="historyTable">
    <thead>
      <tr>
        <th>URL</th>
        <th>Status</th>
        <th>Detections</th>
        <th>Scan Date</th>
        <th>Report</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<div>
<script>
const form = document.getElementById('linkForm');
const result = document.getElementById('result');
const aiDiv = document.getElementById('ai-result');
const checkBtn = document.getElementById('checkBtn');
const historyTbody = document.querySelector('#historyTable tbody');
const API_KEY = 'aae37bf314798b0edf335b4818114280a268aaf936bd7d4b0e695b81870f08a8'; // REGENERATE THIS!

// Suspicious keyword filter
const suspiciousKeywords = ["free-gift","login-now","verify-account","bit.ly","tinyurl","short.ly"];

function getUrlId(url) {
  return btoa(url).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function displayResults(attributes, url, urlId) {
  const stats = attributes.last_analysis_stats || attributes.stats || {};
  const results = attributes.last_analysis_results || attributes.results || {};
  const harmless = stats.harmless || 0;
  const malicious = stats.malicious || 0;
  const suspicious = stats.suspicious || 0;
  const undetected = stats.undetected || 0;
  const timeout = stats.timeout || 0;
  const total = harmless + malicious + suspicious + undetected + timeout;

  let html = `<div class="detection-ratio">${malicious} / ${total} detections</div><div class="scan-details">`;
  Object.keys(results).forEach(engine => {
    const res = results[engine];
    if(res.category==='malicious'||res.result==='malicious'){
      html += `<div>${engine}: ${res.result||res.category}</div>`;
    }
  });
  html += '</div>';
  result.innerHTML = html;

  const status = malicious>0 ? 'Suspicious':'Safe';
  const detections = `${malicious}/${total}`;
  const date = new Date().toLocaleString();
  const reportLink = `https://www.virustotal.com/gui/url/${urlId}`;
  addToHistory(url,status,detections,date,reportLink);
}

function addToHistory(url,status,detections,date,reportLink){
  const row = document.createElement('tr');
  row.innerHTML = `<td>${url}</td><td>${status}</td><td>${detections}</td><td>${date}</td><td><a href="${reportLink}" target="_blank" style="color:#00ffcc;">View Report</a></td>`;
  historyTbody.appendChild(row);
}

async function scanWithVirusTotal(url){
  result.innerHTML = '<div class="loading">ðŸ”„ Checking...</div>';
  checkBtn.disabled = true;
  checkBtn.textContent = 'Checking...';

  // Keyword warnings
  suspiciousKeywords.forEach(kw=>{
    if(url.toLowerCase().includes(kw)){
      result.innerHTML += `<div style="color: yellow;">Warning: URL contains suspicious keyword "${kw}"</div>`;
    }
  });

  const urlId = getUrlId(url);

  // Try existing report first
  let reportResponse = await fetch(`https://www.virustotal.com/api/v3/urls/${urlId}`,{
    headers:{'x-apikey':API_KEY}
  });

  if(reportResponse.ok){
    const reportData = await reportResponse.json();
    displayResults(reportData.data.attributes,url,urlId);
  } else if(reportResponse.status === 404){
    // Submit for new scan
    const scanResponse = await fetch('https://www.virustotal.com/api/v3/urls',{
      method:'POST',
      headers:{'x-apikey':API_KEY},
      body:new URLSearchParams({url})
    });

    if(!scanResponse.ok){
      throw new Error(`HTTP ${scanResponse.status}: ${await scanResponse.text()}`);
    }

    const scanData = await scanResponse.json();
    const analysisId = scanData.data.id;

    result.innerHTML = '<div class="loading">ðŸ”„ Scanning with VirusTotal... Please wait.</div>';

    let attempts = 0, maxAttempts = 15;
    while(attempts < maxAttempts){
      await new Promise(r=>setTimeout(r,2000));
      reportResponse = await fetch(`https://www.virustotal.com/api/v3/analyses/${analysisId}`,{
        headers:{'x-apikey':API_KEY}
      });
      if(!reportResponse.ok){
        throw new Error(`HTTP ${reportResponse.status}: ${await reportResponse.text()}`);
      }
      const reportData = await reportResponse.json();
      if(reportData.data.attributes.status==='completed'){
        displayResults(reportData.data.attributes,url,urlId);
        break;
      }
      attempts++;
    }
  } else {
    throw new Error(`HTTP ${reportResponse.status}: ${await reportResponse.text()}`);
  }

  // Call AI after VT scan
  await askAI(`Analyze this website: ${url}`);
}

async function askAI(prompt){
  const res = await fetch('/api/openai-chat',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({prompt})
  });
  const data = await res.json();
  aiDiv.innerHTML = `<div style="color: lightcyan;">ðŸ’¡ AI Analysis:<br>${JSON.stringify(data,null,2)}</div>`;
}

form.addEventListener('submit', async e=>{
  e.preventDefault();
  const url = document.getElementById('urlInput').value.trim();
  if(!url) return;
  result.innerHTML = '';
  aiDiv.innerHTML = '';
  try{ await scanWithVirusTotal(url); }
  catch(err){ result.innerHTML=`<div style="color: red;">Error: ${err.message}</div>`; }
  finally{ checkBtn.disabled = false; checkBtn.textContent = 'Check'; }
});
</script>
<!-- Suspicious Link Checker Section -->
<section id="link-checker" style="margin-top:30px;">
  <h2>Suspicious Link Checker</h2>
  <form id="linkForm">
    <input type="url" id="urlInput" placeholder="Paste URL here..." required style="width:100%; padding:10px; margin:10px 0;"/>
    <button type="submit" id="checkBtn" style="padding:10px 20px; background:#00ffcc; border:none; cursor:pointer; font-weight:bold;">Check</button>
  </form>
  <div id="result" style="margin-top:20px; font-weight:bold;"></div>
</section>

<script>
// Grab elements
const form = document.getElementById('linkForm');
const result = document.getElementById('result');
const checkBtn = document.getElementById('checkBtn');

// Encode URL helper
function getUrlId(url){
  return btoa(url).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

// Display VirusTotal results
function displayResults(data,url){
  const stats = data.last_analysis_stats || {};
  const malicious = stats.malicious || 0;
  const total = Object.values(stats).reduce((a,b)=>a+b,0);
  result.innerHTML = `<div>${malicious} / ${total} detections</div>`;
}

// Handle form submit
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const url = document.getElementById('urlInput').value.trim();
  if(!url) return;
  result.innerHTML = 'Checking...';
  checkBtn.disabled = true;

  try{
    const res = await fetch('/api/virustotal',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ url })
    });
    const data = await res.json();
    displayResults(data,url);
  }catch(err){
    result.innerHTML = `<div style="color:red;">Error: ${err.message}</div>`;
  }finally{
    checkBtn.disabled=false;
  }
});
</script>
</body>
</html>