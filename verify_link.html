<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Link Safety Checker</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg-1: #06060a; --bg-2: #0b0710;
      --accent: #00ffcc; --muted: #9fb6b0;
      --clean: #16a34a; --suspicious: #f59e0b; --phish: #ef4444; --unrated: #6b7280;
      --bubble-user: #00ffcc25; --bubble-bot: #071218;
    }
    body {
      background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
      color: #e6fff8; font-family: "Orbitron", system-ui, sans-serif;
      min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
    }
    #chat-container {
      flex: 1; overflow-y: auto; padding: 20px 20px 80px; display: flex; flex-direction: column; gap: 16px;
      scroll-behavior: smooth; max-width: 800px; margin: 0 auto; width: 100%;
    }
    .msg {
      max-width: 80%; padding: 12px 16px; border-radius: 16px; line-height: 1.5; word-wrap: break-word;
      font-size: 0.95rem; position: relative; animation: pop 0.25s ease-out;
    }
    @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .user { align-self: flex-end; background: var(--bubble-user); border: 1px solid rgba(0,255,204,0.3); color: #e6fff8; }
    .bot { align-self: flex-start; background: var(--bubble-bot); border: 1px solid rgba(0,255,204,0.1); }
    .bot strong { color: var(--accent); }
    #input-bar {
      position: sticky; bottom: 0; display: flex; padding: 12px; border-top: 1px solid rgba(0,255,204,0.1);
      background: rgba(11,7,16,0.95); max-width: 800px; margin: 0 auto; width: 100%; backdrop-filter: blur(10px);
    }
    #url-input {
      flex: 1; padding: 12px 16px; border: none; background: rgba(0,0,0,0.3); color: #e6fff8;
      border-radius: 8px; font-size: 1rem; outline: none; font-family: "Orbitron", sans-serif;
    }
    #url-input:focus { box-shadow: 0 0 5px rgba(0,255,204,0.5); }
    #send-btn {
      margin-left: 8px; padding: 12px 20px; background: var(--accent); color: #001517; font-weight: 700;
      border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; min-width: 80px; font-size: 1rem;
      font-family: "Orbitron", sans-serif;
    }
    #send-btn:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-1px); }
    #send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .status-safe { color: var(--clean); }
    .status-susp { color: var(--suspicious); }
    .status-bad { color: var(--phish); }
    .vendor-grid {
      margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;
    }
    .vendor-card {
      padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(0,255,204,0.06);
      font-size: 0.85rem; text-align: center; transition: transform 0.2s;
    }
    .vendor-card:hover { transform: scale(1.05); }
    .typing { display: inline-block; font-style: italic; opacity: 0.8; }
    .dot { animation: blink 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 20% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    footer { text-align: center; padding: 10px; color: var(--muted); font-size: 0.8rem; }
    #main-result {
      padding: 20px; margin: 20px 0; border-radius: 12px; background: rgba(0,255,204,0.08);
      border: 1px solid rgba(0,255,204,0.2); font-size: 1rem; text-align: left;
      box-shadow: 0 0 25px rgba(0,255,204,0.1); animation: pop 0.4s ease-out;
      transition: all 0.3s ease;
    }
    #main-result:hover { transform: scale(1.02); box-shadow: 0 0 40px rgba(0,255,204,0.25); }
    #clear-history {
      margin-top: 10px; padding: 8px 16px; background: rgba(255,255,255,0.1); color: var(--accent);
      border: 1px solid rgba(0,255,204,0.3); border-radius: 8px; cursor: pointer; font-size: 0.9rem;
      font-family: "Orbitron", sans-serif;
    }
    #clear-history:hover { background: rgba(255,255,255,0.2); }
    #ai-toggle-btn {
      margin-left: 8px; padding: 12px 16px; background: rgba(0, 255, 204, 0.2); color: var(--accent);
      border: 1px solid rgba(0, 255, 204, 0.3); border-radius: 8px; cursor: pointer; transition: 0.2s;
      font-size: 0.9rem; font-family: "Orbitron", system-ui, sans-serif; font-weight: 600;
    }
    #ai-toggle-btn:hover { background: rgba(0, 255, 204, 0.3); transform: translateY(-1px); }
    #ai-toggle-btn.active { background: var(--accent); color: #001517; }
    @media (max-width: 600px) {
      #chat-container { padding: 12px 12px 70px; gap: 12px; }
      #url-input { font-size: 0.9rem; padding: 10px 12px; }
      #send-btn { padding: 10px 16px; font-size: 0.9rem; min-width: 70px; }
      .vendor-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; }
      .vendor-card { font-size: 0.75rem; padding: 8px; }
      .msg { max-width: 85%; font-size: 0.9rem; }
      #main-result { padding: 15px; font-size: 0.95rem; }
      #ai-toggle-btn { padding: 10px 12px; font-size: 0.8rem; }
    }
    @media (max-width: 400px) {
      #input-bar { padding: 10px; }
      #url-input { font-size: 0.85rem; }
      #send-btn { padding: 8px 12px; font-size: 0.85rem; }
      #ai-toggle-btn { padding: 8px 10px; font-size: 0.75rem; }
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div class="msg bot"><strong>‚ö°Ô∏è Yo!</strong> Toss me any link, and I'll hit it with a full security scan to keep you safe! üîç</div>
  </div>
  <div id="input-bar">
    <input id="url-input" type="text" placeholder="Paste a link to check..." autocomplete="off">
    <button id="ai-toggle-btn">ü§ñ AI MODE</button>
    <button id="send-btn">Send</button>
  </div>
  <footer>Secure ‚Ä¢ Protect ‚Ä¢ Respond</footer>

  <script>
    // API endpoints
    const VT_BACKEND = 'https://ethwebsite-ulau.onrender.com/api/virustotal';
    const URLSCAN_BACKEND = 'https://ethwebsite-ulau.onrender.com/api/urlscan';
    const CHAT_BACKEND = 'https://ethwebsite-ulau.onrender.com/chat';
    
    const chat = document.getElementById('chat-container');
    const input = document.getElementById('url-input');
    const sendBtn = document.getElementById('send-btn');
    const aiToggleBtn = document.getElementById('ai-toggle-btn');

    // AI Chat State
    let aiChatActive = false;

    function addMessage(text, sender = 'bot') {
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      div.innerHTML = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function verdictClass(v) {
      if (v === 'phish' || v === 'malicious') return 'status-bad';
      if (v === 'suspicious') return 'status-susp';
      return 'status-safe';
    }

    function addTyping() {
      if (aiChatActive) {
        return addMessage(`<span class="typing">Thinking<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>`, 'bot');
      }
      return addMessage(`<span class="typing">Scanning<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>`, 'bot');
    }

    // AI Chat Handler
    async function askAIQuestion(question) {
      const typingDiv = addTyping();
      sendBtn.disabled = true;
      sendBtn.textContent = 'Thinking...';

      try {
        console.log('Sending to AI:', question);
        
        const response = await fetch(CHAT_BACKEND, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            prompt: question,
            message: question
          })
        });

        console.log('AI Response status:', response.status);
        
        const aiData = await response.json();
        console.log('AI Response data:', aiData);
        
        typingDiv.remove();
        
        if (aiData.response) {
          addMessage(aiData.response, 'bot');
        } else if (aiData.error) {
          addMessage(`ü§ñ ${aiData.error}`, 'bot');
        } else {
          addMessage("üîê I'm here to help with security questions! Our platform uses VirusTotal (90+ vendors) and URLScan.io to detect threats. What would you like to know?", 'bot');
        }

      } catch (error) {
        console.error('AI Error:', error);
        typingDiv.remove();
        addMessage(`üõ°Ô∏è Connection issue! But I can tell you: Our scanner uses VirusTotal's 90+ security engines plus URLScan.io to detect malware, phishing, and breaches in real-time. What security topic interests you?`, 'bot');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Ask';
        input.value = '';
      }
    }

    // URL Scanning Handler
    async function analyzeLink(url) {
      const typingDiv = addTyping();
      sendBtn.disabled = true;
      sendBtn.textContent = 'Scanning...';
      let resultBox = document.getElementById('main-result');
      if (!resultBox) {
        resultBox = document.createElement('div');
        resultBox.id = 'main-result';
        chat.prepend(resultBox);
      }

      try {
        // VirusTotal scan
        const vtResp = await fetch(VT_BACKEND, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        if (!vtResp.ok) {
          throw new Error(`VirusTotal error ${vtResp.status}`);
        }
        const vtData = await vtResp.json();

        const vendors = vtData.last_analysis_results
          ? Object.entries(vtData.last_analysis_results).map(([name, info]) => {
              const cat = info?.category?.toLowerCase() || 'unrated';
              let v = 'unrated';
              if (cat === 'malicious' || cat === 'phishing') v = 'phish';
              else if (cat === 'suspicious') v = 'suspicious';
              else if (cat === 'harmless' || cat === 'clean') v = 'clean';
              return { name, verdict: v };
            })
          : [];

        const stats = { mal: 0, susp: 0, clean: 0 };
        vendors.forEach(v => {
          if (v.verdict === 'phish') stats.mal++;
          else if (v.verdict === 'suspicious') stats.susp++;
          else if (v.verdict === 'clean') stats.clean++;
        });

        const total = vendors.length;
        const threatCount = stats.mal + stats.susp;
        let status = 'safe', label = 'CLEAN', message = 'Looks good! This link is safe to visit. üòé';
        if (stats.mal > 0) {
          status = 'bad';
          label = 'MALICIOUS';
          message = 'Yikes! This link is dangerous. Steer clear! üö®';
        } else if (stats.susp > 0) {
          status = 'susp';
          label = `SUSPICIOUS (${stats.susp} flagged)`;
          message = 'Hmm, this link looks a bit sketchy. Proceed with caution! ‚ö†Ô∏è';
        }

        let html = `<strong>üîç Status:</strong> <span class="${'status-' + status}">${label}</span><br>
          <small>Detections: ${threatCount}/${total}</small><br>
          <small>${message}</small>`;
        html += `<div class="vendor-grid">` +
          vendors.slice(0, 90).map(v => `
            <div class="vendor-card">${v.name}<br><span class="${verdictClass(v.verdict)}">${v.verdict.toUpperCase()}</span></div>
          `).join('') + `</div>`;

        // URLScan.io integration
        const scanResp = await fetch(URLSCAN_BACKEND, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        if (scanResp.ok) {
          const scanData = await scanResp.json();
          if (scanData.result_url) {
            html += `<br><small>Full URLScan Report: <a href="${scanData.result_url}" target="_blank" style="color: var(--accent);">${scanData.scan_id}</a></small>`;
          }
        }

        typingDiv.remove();
        resultBox.innerHTML = `<strong>üîç Latest Scan Result</strong><br><br>${html}`;
        addMessage(message, 'bot');

        // Save scan history
        const saved = JSON.parse(sessionStorage.getItem('ezm_history') || '[]');
        saved.unshift({ url, status, detections: threatCount, total, timestamp: new Date().toISOString() });
        if (saved.length > 50) saved.pop();
        sessionStorage.setItem('ezm_history', JSON.stringify(saved));

        if (saved.length > 0 && !document.getElementById('clear-history')) {
          const clearBtn = document.createElement('button');
          clearBtn.id = 'clear-history';
          clearBtn.textContent = 'Clear Scan History';
          clearBtn.onclick = () => {
            sessionStorage.removeItem('ezm_history');
            clearBtn.remove();
            addMessage('Scan history cleared! üöÄ', 'bot');
          };
          resultBox.appendChild(clearBtn);
        }

        input.value = '';
      } catch (e) {
        console.error('Scan error:', e);
        typingDiv.remove();
        addMessage(`Whoops, something broke! ${e.message.includes('401') ? 'API key issue.' : e.message.includes('429') ? 'Rate limit hit.' : 'Try again later.'} üòÖ`, 'bot');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    // Toggle AI Chat Mode
    function toggleAIChat() {
      aiChatActive = !aiChatActive;
      
      if (aiChatActive) {
        aiToggleBtn.classList.add('active');
        input.placeholder = "Ask me about security, breaches, malware...";
        sendBtn.textContent = 'Ask';
        chat.innerHTML = '';
        addMessage(`<strong>ü§ñ AI Security Assistant</strong><br>Hey! I'm here to answer questions about:<br>
          ‚Ä¢ How our URL scanning works<br>
          ‚Ä¢ Types of threats (malware, phishing, breaches)<br>
          ‚Ä¢ VirusTotal & URLScan.io features<br>
          ‚Ä¢ Online security best practices<br><br>
          What would you like to know? üîç`, 'bot');
      } else {
        aiToggleBtn.classList.remove('active');
        input.placeholder = "Paste a link to check...";
        sendBtn.textContent = 'Send';
        chat.innerHTML = '';
        addMessage(`<strong>‚ö°Ô∏è Yo!</strong> Toss me any link, and I'll hit it with a full security scan to keep you safe! üîç`, 'bot');
      }
    }

    // Main Send Handler
    sendBtn.onclick = () => {
      const val = input.value.trim();
      if (!val) return;
      
      addMessage(val, 'user');
      
      if (aiChatActive) {
        askAIQuestion(val);
      } else {
        let normalized = val;
        if (!/^https?:\/\//i.test(val)) normalized = 'http://' + val;
        try {
          new URL(normalized);
          analyzeLink(normalized);
        } catch {
          addMessage('Oops, that\'s not a valid URL. Try https://example.com üò¨', 'bot');
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send';
          input.value = '';
        }
      }
    };

    // Toggle button handler
    aiToggleBtn.onclick = toggleAIChat;

    // Enter key handler
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !sendBtn.disabled) sendBtn.click();
    });

    // Debug log on page load
    console.log('üîß Debug Info:');
    console.log('VT Backend:', VT_BACKEND);
    console.log('URLScan Backend:', URLSCAN_BACKEND);
    console.log('Chat Backend:', CHAT_BACKEND);
  </script>

</body>
</html>