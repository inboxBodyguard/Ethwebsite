<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Incident Playbook â€” Enriched</title>
  <style>
    :root{ --bg:#071426; --card:#0b1220; --accent:#16a34a; --muted:#94a3b8; --danger:#dc2626; color-scheme: dark; }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071028 0%, #071426 100%);color:#e6eef8;font-family:Inter,system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .wrap{max-width:1100px;margin:28px auto;padding:20px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    header h1{font-size:18px;margin:0}
    .meta{color:var(--muted);font-size:13px}
    select, button { font-family:inherit; }
    .container{display:block}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn {background:var(--accent);border:0;color:#041017;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    #output{margin-top:14px}
    .step-item{border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;margin-bottom:10px}
    .step-h{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .step-h h3{margin:0;font-size:15px}
    .muted{color:var(--muted)}
    .details{margin-top:10px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;display:none}
    .details pre{background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;overflow:auto;color:#d3f9d8}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Incident Playbook â€” Enriched Defensive Intelligence</h1>
        <div class="meta">Loads playbooks.json â†’ enriches steps with MITRE, SIEM, forensic tips, automation payloads</div>
      </div>
      <div class="controls">
        <select id="incident"></select>
        <button id="genBtn" class="btn">Generate</button>
        <button id="pdfBtn" class="btn secondary">Export PDF</button>
        <button id="saveBtn" class="btn secondary">Save</button>
      </div>
    </header>

    <div id="output" class="card"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    /************************************************************************
     * CONFIG â€” set webhook_endpoint if you want automation send
     ************************************************************************/
    const CONFIG = {
      webhook_submit: "" // example: "https://your-soar.example/webhook"
    };

    // Fallback default (still defensive)
    const defaultPlaybooks = {
      "Phishing Email": [
        "ðŸš¨ Immediately disconnect affected device from the network to prevent lateral movement.",
        "ðŸ“§ Collect and preserve complete email headers, attachments, and metadata for forensic analysis.",
        "ðŸ” Analyze suspicious links/domains using VirusTotal, URLVoid, and threat intelligence platforms."
      ],
      "Ransomware Infection": [
        "ðŸ”Œ Immediately isolate infected systems - disconnect network cables and disable WiFi.",
        "ðŸš« DO NOT pay ransom - contact FBI's IC3 and local law enforcement immediately.",
        "ðŸ’¾ Identify and verify integrity of latest clean backups before restoration begins."
      ]
    };

    // Basic helpers used to generate defensive enrichment for each step.
    function enrichStep(stepText){
      // Map phrases to plausible MITRE IDs (defensive suggestions only)
      const mitreMap = [
        {match: /phish|email|link|attachment/i, ids:["T1566"], note:"Phishing - user-targeted social engineering."},
        {match: /ransom|encryption|backup/i, ids:["T1486"], note:"Ransomware - encryption of data."},
        {match: /credential|password|login/i, ids:["T1110","T1078"], note:"Credential access / account misuse."},
        {match: /isolate|network|lateral/i, ids:["T1087","T1570"], note:"Lateral movement / discovery."},
        {match: /malware|sandbox|scan/i, ids:["T1059"], note:"Malware detection and analysis."},
        {match: /ddos|traffic|waf/i, ids:["T1499"], note:"DDoS - volumetric or application layer."}
      ];
      let mitre_ids = new Set();
      let mitre_notes = [];
      for(const m of mitreMap){
        if(m.match.test(stepText)){ m.ids.forEach(i=>mitre_ids.add(i)); mitre_notes.push(m.note); }
      }
      if(mitre_ids.size === 0){
        mitre_ids.add("TTP-UNKNOWN");
        mitre_notes.push("General detection & containment guidance.");
      }

      // Simple SIEM query examples (defensive) â€” generic placeholders
      const splunk = `index=main earliest=-24h | search "${escapeForQuery(stepText).slice(0,120)}" | stats count by src_ip, user`;
      const kql = `SecurityEvent | where TimeGenerated > ago(1d) | where tostring(EventData) contains "${escapeForQuery(stepText).slice(0,80)}" | summarize count() by IPAddress, Account`;
      const sigma = `title: Suspicious activity related to playbook step
detection:
  selection:
    Event|contains: "${escapeForQuery(stepText).slice(0,60)}"
  condition: selection
level: medium`;

      // Forensics checklist (defensive)
      const forensic = [
        "Collect volatile memory (RAM) if possible for malware artifacts.",
        "Capture full system image (bit-for-bit) before remediation.",
        "Export relevant logs (auth, mail, proxy, firewall) and preserve timestamps."
      ];

      // YARA-like stub (detection placeholder, defensive)
      const yara = `rule suspicious_playbook_indicator {\n  meta:\n    author = "IR Team"\n    description = "Defensive stub for indicators related to playbook step"\n  strings:\n    $s1 = "${escapeForQuery(stepText).slice(0,40)}"\n  condition:\n    any of them\n}`;

      // Automation payload (safe template)
      const webhookPayload = {
        incident_id: "{{INCIDENT_ID}}",
        step_text: stepText,
        severity: "medium",
        suggested_action: stepText,
        timestamp: new Date().toISOString()
      };

      return {
        step: stepText,
        mitre_ids: Array.from(mitre_ids),
        mitre_notes: mitre_notes,
        siem: {splunk, kql, sigma},
        forensic,
        yara_stub: yara,
        automation_payload: webhookPayload
      };
    }

    function escapeForQuery(s){ return String(s).replace(/["']/g,""); }
    function copyToClipboard(txt){ navigator.clipboard.writeText(txt).then(()=>flash("Copied to clipboard")); }

    // UI: flash small message
    function flash(msg, err=false){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',padding:'8px 12px',background: err? '#c84c4c': '#16a34a',color:'#001214',borderRadius:'6px',zIndex:9999}); document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

    // load playbooks.json with fallback
    async function loadPlaybooks(){
      try{
        const res = await fetch('playbooks.json');
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        window.playbooks = data;
        populateDropdown(Object.keys(data));
        console.log("Loaded playbooks.json");
      }catch(e){
        console.warn("playbooks.json not loaded, using fallback", e);
        window.playbooks = defaultPlaybooks;
        populateDropdown(Object.keys(defaultPlaybooks));
      }
    }

    function populateDropdown(keys){
      const select = document.getElementById('incident');
      select.innerHTML = "";
      keys.forEach(k=>{
        const o = document.createElement('option'); o.value=k; o.textContent=k; select.appendChild(o);
      });
    }

    // Generate UI for chosen playbook
    function generate(){
      const type = document.getElementById('incident').value;
      const steps = window.playbooks[type] || [];
      const output = document.getElementById('output');
      output.innerHTML = `<h2 style="margin:0 0 12px">${type}</h2>`;
      for(let i=0;i<steps.length;i++){
        const stepText = steps[i];
        const enriched = enrichStep(stepText);
        const div = document.createElement('div');
        div.className = 'step-item';
        div.innerHTML = `
          <div class="step-h">
            <h3>Step ${i+1} â€” ${escapeHtml(stepText)}</h3>
            <div class="tiny muted">MITRE: ${enriched.mitre_ids.join(', ')}</div>
          </div>
          <div class="muted tiny" style="margin-top:6px">${enriched.mitre_notes.join(' â€¢ ')}</div>
          <div class="actions">
            <button class="btn secondary" data-copy-splunk>Copy Splunk</button>
            <button class="btn secondary" data-copy-kql>Copy KQL</button>
            <button class="btn secondary" data-copy-sigma>Copy Sigma</button>
            <button class="btn secondary" data-copy-yara>Copy YARA stub</button>
            <button class="btn" data-toggle-details>Details</button>
            <button class="btn" data-send-webhook>Send to Webhook</button>
          </div>
          <div class="details" aria-hidden="true">
            <div><strong>Forensic actions:</strong>
              <ul>${enriched.forensic.map(f=>`<li class="muted tiny">${escapeHtml(f)}</li>`).join('')}</ul>
            </div>
            <div><strong>SIEM â€” Splunk:</strong><pre>${escapeHtml(enriched.siem.splunk)}</pre></div>
            <div><strong>SIEM â€” KQL:</strong><pre>${escapeHtml(enriched.siem.kql)}</pre></div>
            <div><strong>Sigma example:</strong><pre>${escapeHtml(enriched.siem.sigma)}</pre></div>
            <div><strong>YARA stub:</strong><pre>${escapeHtml(enriched.yara_stub)}</pre></div>
            <div><strong>Automation payload (preview):</strong><pre>${escapeHtml(JSON.stringify(enriched.automation_payload,null,2))}</pre></div>
          </div>
        `;
        // attach handlers for buttons inside this div
        output.appendChild(div);

        // query selectors relative to div
        (function localize(el, enriched){
          el.querySelector('[data-toggle-details]').addEventListener('click', (e)=>{
            const det = el.querySelector('.details');
            const open = det.style.display === 'block';
            det.style.display = open ? 'none' : 'block';
            det.setAttribute('aria-hidden', open ? 'true' : 'false');
          });
          el.querySelector('[data-copy-splunk]').addEventListener('click', ()=> copyToClipboard(enriched.siem.splunk));
          el.querySelector('[data-copy-kql]').addEventListener('click', ()=> copyToClipboard(enriched.siem.kql));
          el.querySelector('[data-copy-sigma]').addEventListener('click', ()=> copyToClipboard(enriched.siem.sigma));
          el.querySelector('[data-copy-yara]').addEventListener('click', ()=> copyToClipboard(enriched.yara_stub));
          el.querySelector('[data-send-webhook]').addEventListener('click', async ()=>{
            if(!CONFIG.webhook_submit){ flash('Webhook not configured', true); return; }
            const payload = Object.assign({}, enriched.automation_payload, {incident_type: type, step_index: i+1});
            try{
              const res = await fetch(CONFIG.webhook_submit, {method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(payload)});
              if(res.ok){ flash('Webhook sent'); } else { flash('Webhook error', true); }
            }catch(err){ console.error(err); flash('Webhook failed', true); }
          });
        })(div, enriched);
      }
    }

    // PDF export (takes visible text)
    document.getElementById('pdfBtn').addEventListener('click', ()=>{
      const text = document.getElementById('output').innerText;
      if(!text.trim()){ flash('Generate playbook first', true); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      const split = doc.splitTextToSize(text, 170);
      doc.text(split, 14, 20);
      doc.save('playbook.pdf');
    });

    // Save / local persistence of last generated playbook
    document.getElementById('saveBtn').addEventListener('click', ()=>{
      const type = document.getElementById('incident').value;
      const payload = {type, data: window.playbooks[type] || [], saved_at: new Date().toISOString()};
      localStorage.setItem('last_playbook', JSON.stringify(payload));
      flash('Playbook saved locally');
    });

    // util: escape for HTML
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // init
    document.getElementById('genBtn').addEventListener('click', generate);
    window.addEventListener('DOMContentLoaded', loadPlaybooks);
  </script>
</body>
</html>